---
import TaskPageWrapper from "../components/TaskPageWrapper";
import Layout from "../layouts/Layout.astro";

export const prerender = false;

// Ensure user is authenticated (middleware should handle this, but double-check)
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login");
}

// Check if user has an active task
const supabase = Astro.locals.supabase;
const today = new Date().toISOString().split("T")[0];

const { data: activeTask } = await supabase
  .from("user_tasks")
  .select("*")
  .eq("user_id", user.id)
  .eq("task_date", today)
  .single();

// If no active task or task is not pending, redirect to check-in
if (!activeTask || activeTask.status !== "pending") {
  return Astro.redirect("/checkin");
}
---

<Layout title='Twoje zadanie - MIMO'>
  <TaskPageWrapper client:load />
</Layout>
